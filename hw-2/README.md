# Детекция фродовых транзакций

Сервис для детекции фрода с использованием Kafka, CatBoost и PostgreSQL.

> У меня был небольшой опыт с Kafka, и в этом проекте решил попробовать KRaft режим, чтобы не поднимать отдельный Zookeeper. Хотел посмотреть как это работает. В итоге оказалось, что с Zookeeper было бы проще - меньше возни с дополнительными параметрами и командами для форматирования storage. Но зато теперь знаю как работает KRaft:)

## Что это

Система читает транзакции из Kafka, прогоняет через модель CatBoost, сохраняет результаты в PostgreSQL и показывает их в веб-интерфейсе.

**Архитектура:**
```
test.csv → Producer → Kafka → Scoring → Kafka → DB Writer → PostgreSQL → Streamlit UI
```

**Компоненты:**
- Kafka - для передачи сообщений
- PostgreSQL - для хранения результатов
- Producer - читает test.csv и отправляет в Kafka батчами по 1000
- Scoring Service - применяет модель к транзакциям
- DB Writer - сохраняет результаты в БД
- Streamlit UI - веб-интерфейс для просмотра

## Как работает обработка

**Батчинг:**
1. Producer читает `test.csv` и разбивает на батчи по 1000 транзакций
2. Каждый батч отправляется в Kafka как одно сообщение
3. Scoring Service получает батчи и обрабатывает их моделью

**Обработка больших батчей:**
Если вдруг приходит батч больше 1000 транзакций (например, кто-то отправил 5000 сразу), то модель обрабатывает их поэтапно - по 1000 за раз. Это сделано чтобы не перегружать память при inference.

**Результаты:**
- Результаты тоже отправляются батчами в Kafka
- DB Writer читает батчи результатов и сохраняет их в PostgreSQL

## Как запустить

Первый запуск:
```bash
cd hw-2
docker compose down -v
docker compose up --build
```

UI доступен по адресу: http://localhost:8501

## Что показывает UI

Кнопка "Посмотреть результаты" показывает:
- 10 последних фродовых транзакций
- Гистограмму распределения скоров (можно выбрать количество записей от 10 до 500)

## Основные файлы

- `producer.py` - отправляет транзакции в Kafka
- `main.py` - scoring сервис
- `preprocess.py` - обработка фичей
- `score.py` - применение модели CatBoost
- `db_writer.py` - запись результатов в БД
- `ui.py` - веб-интерфейс
- `docker-compose.yml` - конфигурация всех сервисов

## Требования

- Docker и docker-compose
- Модель в `../data/models/catboost_model.cbm`
- Статистика в `../data/models/stats.json`
- Данные в `../data/test.csv`
